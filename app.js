EDB = [
    {
      "Name": "Complete Fitness Regimen",
      "Description": "An all-encompassing workout plan designed to improve overall fitness through a variety of exercises.",
      "Difficulty": "medium",
      "Age rating": "16+",
      "KeyWords": [
        "Strength",
        "Cardio Health",
        "Flexibility",
        "Endurance"
      ],
      "ProgressList": [
        {
          "Taskname": "Warm-Up",
          "Base": "Time",
          "SetDesc" : ["Light Jogging", "Dynamic Stretches"],
          "TaskDiscr": "Light cardio and stretching to prepare the body.",
          "TaskContent": "5 minutes of jogging followed by 4 minutes of dynamic stretches.",
          "TaskDay": 20,
          "TaskDayL": 20,
          "TaskState": false,
          "Time": 5,
          "Reps": "N/A",
          "Sets": 2,
          "Break": 1,
        },
        {
          "Taskname": "Push-Ups",
          "Base": "Rep",
          "SetDesc" : ["Push-Ups | 15 Reps", "Push-Ups | 15 Reps", "Push-Ups | 15 Reps", ],
          "TaskDiscr": "Upper body strength exercise focusing on the chest, shoulders, and triceps.",
          "TaskContent": "3 sets of 15 reps.",
          "TaskDay": 20,
          "TaskDayL": 20,
          "TaskState": false,
          "Time": "N/A",
          "Reps": 15,
          "Sets": 3,
          "Break": 1,
        },
        {
          "Taskname": "Bodyweight Squats",
          "Base": "Rep",
          "SetDesc" : ["Bodyweight Squats | 20 Reps", "Bodyweight Squats | 20 Reps", "Bodyweight Squats | 20 Reps", ],
          "TaskDiscr": "Lower body exercise focusing on the quadriceps, hamstrings, and glutes.",
          "TaskContent": "3 sets of 20 reps.",
          "TaskDay": 20,
          "TaskDayL": 20,
          "TaskState": false,
          "Time": "N/A",
          "Reps": 20,
          "Sets": 3,
          "Break": 1
        },
        {
          "Taskname": "Plank",
          "Base": "Time",
          "SetDesc" : ["Plank | 1 Minutes", "Plank | 1 Minutes", "Plank | 1 Minutes", ],
          "TaskDiscr": "Core strengthening exercise focusing on stabilizing the core.",
          "TaskContent": "3 sets of 1-minute holds.",
          "TaskDay": 20,
          "TaskDayL": 20,
          "TaskState": false,
          "Time": 1,
          "Reps": "N/A",
          "Sets": 3,
          "Break": 1,
        },
        {
          "Taskname": "Jumping Jacks",
          "Base": "Time",
          "SetDesc" : ["Jumping Jacks | 1 Minutes", "Jumping Jacks | 1 Minutes", "Jumping Jacks | 1 Minutes", "Jumping Jacks | 1 Minutes","Jumping Jacks | 1 Minutes",],
          "TaskDiscr": "Cardio exercise to improve cardiovascular health and burn calories.",
          "TaskContent": "3 sets of 1 minute each.",
          "TaskDay": 20,
          "TaskDayL": 20,
          "TaskState": false,
          "Time": 1,
          "Reps": "N/A",
          "Sets": 5,
          "Break": 1
        },
        {
          "Taskname": "Lunges",
          "Base": "Rep",
          "SetDesc" : [ "Lunges | 15 reps each leg","Lunges | 15 reps each leg","Lunges | 15 reps each leg","Lunges | 15 reps each leg","Lunges | 15 reps each leg", ],
          "TaskDiscr": "Lower body exercise to target the quadriceps, hamstrings, and glutes.",
          "TaskContent": "3 sets of 15 reps per leg.",
          "TaskDay": 20,
          "TaskDayL": 20,
          "TaskState": false,
          "Time": "N/A",
          "Reps": 30,
          "Sets": 3,
          "Break": 1
        },
        {
          "Taskname": "Burpees",
          "Base": "Rep",
          "SetDesc" : [ "Burpees | 12 reps","Burpees | 12 reps","Burpees | 12 reps",],
          "TaskDiscr": "Full-body exercise combining a squat, jump, and push-up for endurance and strength.",
          "TaskContent": "3 sets of 12 reps.",
          "TaskDay": 20,
          "TaskDayL": 20,
          "TaskState": false,
          "Time": "N/A",
          "Reps": 12,
          "Sets" : 3,
          "Break": 1
        },
        {
          "Taskname": "Mountain Climbers",
          "Base": "Time",
          "SetDesc" : [ "Mountain Climbers | 1 minutes","Mountain Climbers | 1 minutes","Mountain Climbers | 1 minutes",],
          "TaskDiscr": "Full-body exercise combining a squat, jump, and push-up for endurance and strength.",
          "TaskDiscr": "Cardio and core exercise to increase heart rate and strengthen the core.",
          "TaskContent": "3 sets of 1 minute each.",
          "TaskDay": 20,
          "TaskDayL": 20,
          "TaskState": false,
          "Time": 1,
          "Reps": "N/A",
          "Sets" : 3,
          "Break": 1
        },
        {
          "Taskname": "Dumbbell Rows",
          "Base": "Rep",
          "SetDesc" : [ "Dumbbell Rows | 12 reps per arm","Dumbbell Rows | 12 reps per arm","Dumbbell Rows | 12 reps per arm",],
          "TaskDiscr": "Strength exercise for the back using dumbbells.",
          "TaskContent": "3 sets of 12 reps per arm.",
          "TaskDay": 5,
          "TaskDayL": 5,
          "TaskState": false,
          "Time": "N/A",
          "Reps": 24,
          "Sets" : 3,
          "Break": 1
        },
        {
          "Taskname": "Bicycle Crunches",
          "Base": "Rep",
          "SetDesc" : [ "Bicycle Crunches | 20 reps per side","Bicycle Crunches | 20 reps per side","Bicycle Crunches | 20 reps per side",],
          "TaskDiscr": "Full-body exercise combining a squat, jump, and push-up for endurance and strength.",
          "TaskContent": "3 sets of 20 reps per side.",
          "TaskDay": 5,
          "TaskDayL": 5,
          "TaskState": false,
          "Time": "N/A",
          "Reps": 40,
          "Sets" : 3,
          "Break": 1
        },
        {
          "Taskname": "High Knees",
          "Base": "Time",
          "SetDesc" : [ "High Knees | 1 minute","High Knees | 1 minute","High Knees | 1 minute",],
          "TaskDiscr": "Cardio exercise to improve cardiovascular endurance and leg strength.",
          "TaskContent": "3 sets of 1 minute each.",
          "TaskDay": 7,
          "TaskDayL": 7,
          "TaskState": false,
          "Time": 1,
          "Reps": "N/A",
          "Sets" : 3,
          "Break": 1,
        },
        {
          "Taskname": "Tricep Dips",
          "Base": "Rep",
          "SetDesc" : [ "Tricep Dips | 15 reps","Tricep Dips | 15 reps","Tricep Dips | 15 reps",],
          "TaskDiscr": "Strength exercise focusing on the triceps using body weight or a bench.",
          "TaskContent": "3 sets of 15 reps.",
          "TaskDay": 7,
          "TaskDayL": 7,
          "TaskState": false,
          "Time": "N/A",
          "Reps": 15,
          "Sets" : 3,
          "Break": 1
        },
        {
          "Taskname": "Leg Raises",
          "Base": "Rep",
          "SetDesc" : [ "Leg Raises | 15 reps","Leg Raises | 15 reps","Leg Raises | 15 reps",],
          "TaskDiscr": "Core exercise focusing on the lower abdominals.",
          "TaskContent": "3 sets of 15 reps.",
          "TaskDay": 7,
          "TaskDayL": 7,
          "TaskState": false,
          "Time": "N/A",
          "Reps": 15,
          "Sets": 3,
          "Break": 1
        },
        {
          "Taskname": "Cardio Session",
          "Base": "Time",
          "SetDesc" : ["Cardio Session | 20 minutes"],
          "TaskDiscr": "Moderate-intensity cardio workout to enhance cardiovascular health.",
          "TaskContent": "20 minutes of brisk walking or jogging.",
          "TaskDay": 2,
          "TaskDayL": 2,
          "TaskState": false,
          "Time": "20 minutes",
          "Reps": "N/A",
          "Sets" : 1,
          "Break": "None"
        },
      ]
    }
  ]


//   const allPreferences = [
//     "Strength",
//     "Endurance",
//     "Flexibility",
//     "Weight Loss",
//     "Muscle Gain",
//     "Cardio Health",
//     "Balance",
//     "Recovery",
//     "Energy",
//     "Performance",
//     "Power",
//     "Core Stability",
//     "Mobility",
//     "Agility",
//     "Speed",
//     "Posture",
//     "Detox",
//     "Hydration",
//     "Immune Support",
//     "Metabolism"
// ];

const auth = firebase.auth();
const db = firebase.firestore();
const whenSignedIn = document.getElementById('whenSignedIn');
const whenSignedOut = document.getElementById('whenSignedOut');

const SignInBtn = document.getElementById('SignInBtn');
const SignOutBtn = document.getElementById('SignOutBtn');
const sumbitBtn = document.getElementById('submitBtn');

const provider = new firebase.auth.GoogleAuthProvider();

SignInBtn.onclick = () => auth.signInWithPopup(provider);
try {
SignOutBtn.onclick = () => auth.signOut();}
catch {}

auth.onAuthStateChanged(user => {
    if (user) {
        whenSignedIn.hidden = false;
        whenSignedOut.hidden = true;
    } else {
        whenSignedIn.hidden = true;
        whenSignedOut.hidden = false;
    }
});

function ExerciseORPreferences(){

let thingsRef; 
let unsubscribe;

auth.onAuthStateChanged(user => {

    if (user) {

        
        thingsRef = db.collection('preferences')
        
        unsubscribe = thingsRef
            .where('uid', '==', user.uid)
            .onSnapshot(querySnapshot => {
              
                if (querySnapshot.empty) {
                  window.location.href = "PreferencesLoad.html";
                } 
                else {
                    window.location.href = "eLoad.html";
                }
            });
    }
    
    else {

        unsubscribe && unsubscribe();
    }
});
};


async function getUserPreferences(userInfo, allPreferences) {
  const MAX_PREFERENCES = 4;
  const API_KEY = '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'; // Replace with your actual API key
  const API_URL = 'https://api.openai.com/v1/chat/completions';

  const prompt = `Given the following user information:
${JSON.stringify(userInfo, null, 2)}

And the following list of possible preferences:
${allPreferences.join(', ')}

Please select ${MAX_PREFERENCES} preferences that would be most suitable for this user. Return only the list of selected preferences, separated by commas.`;

  try {
    const response = await fetch(API_URL, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${API_KEY}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        model: "gpt-4o-mini", // GPT-4 Turbo mini model
        messages: [{ role: "user", content: prompt }],
        max_tokens: 100,
        n: 1,
        temperature: 0.5,
      }), 
    });

    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }

    const data = await response.json();
    const aiResponse = data.choices[0].message.content.trim();
    
    // Split the response into an array and trim each preference
    let selectedPreferences = aiResponse.split(',').map(pref => pref.trim());
    
    // Filter out any empty strings
    selectedPreferences = selectedPreferences.filter(pref => pref !== '');

    // Ensure all returned preferences are in the original allPreferences list
    selectedPreferences = selectedPreferences.filter(pref => allPreferences.includes(pref));
    console.log('User Info:', userInfo);
    console.log('API Response:', data);
    console.log('Selected Preferences:', selectedPreferences);
    PreferencesPush(selectedPreferences);

    
  } catch (error) {
    console.error('Error determining user preferences:', error.message);
    return [];
  }
};


function PreferencesPush(preferences){
        
  auth.onAuthStateChanged(user => {
        thingsRef = db.collection('preferences')

        thingsRef.add({
          uid: user.uid,
          Preference: preferences ,
      });
      console.log("PUSHED")
      

        unsubscribe = thingsRef
            .where('uid', '==', user.uid)
            .onSnapshot(querySnapshot => {
              querySnapshot.docs.forEach(doc => {
                console.log(doc.data().Preference);
              });
            });
      
  });

};


function DisplayUserPreferences(){
  let thingsRef;
  let unsubscribe;
  auth.onAuthStateChanged(user => {
  
    if (user) {
  
  
        thingsRef = db.collection('preferences')
  
        unsubscribe = thingsRef
            .where('uid', '==', user.uid)
            .onSnapshot(querySnapshot => {
                const items = querySnapshot.docs.map(doc => {
                    return `<li> ${doc.data().Preference} </li>`;
                });
  
                document.getElementById('preferences').innerHTML = items.join(', ');
            });
  
  
  
    } else {
  
        unsubscribe && unsubscribe();
    }
  });
};


function ExerciseFinder(exercises){
  auth.onAuthStateChanged(user => {
    if (user) {
      thingsRef = db.collection('exercises')
      unsubscribe = thingsRef
          .where('uid', '==', user.uid)
          .onSnapshot(querySnapshot => {
            if (querySnapshot.empty) {
              window.location.href = "ePlan.html";
            }
            else {
                window.location.href = "ePlanDetails.html";
            }
          });
    }
  });
}


function StartPlan(index){
  console.log("PUSHED")
  auth.onAuthStateChanged(user => {

    thingsRef = db.collection('exercises')
    
      thingsRef.add({
        uid: user.uid,
        Plan: index,
    });
    
    
      unsubscribe = thingsRef
          .where('uid', '==', user.uid)
          .onSnapshot(querySnapshot => {
            if (querySnapshot.empty) {
              setTimeout(() => {
                window.location.href = "ePlan.html";
              }, 2000);
              
            }
            else {
              setTimeout(() => {
                window.location.href = "ePlanDetails.html";
              }, 2000);
            }
          });
    }
  );
}


function sessionInitiated(){
  auth.onAuthStateChanged(user => {
    if (user) {
      thingsRef = db.collection('exercises')
      unsubscribe = thingsRef
          .where('uid', '==', user.uid)
          .onSnapshot(querySnapshot => {
            if (querySnapshot.empty) {
              window.location.href = "ePlan.html";
            }  
          });
    }
  });
}


function CompleteSession(plan){
  auth.onAuthStateChanged(user => {

    thingsRef = db.collection('sessions')
    
      thingsRef.add({
        uid: user.uid,
        Plan: plan,
        Number: 1,
    });
    }
  );
}


function PreferencesCheck(mode){
  auth.onAuthStateChanged(user => {

    if (user) {

        
        thingsRef = db.collection('preferences')
        
        unsubscribe = thingsRef
            .where('uid', '==', user.uid)
            .onSnapshot(querySnapshot => {
              
                if (querySnapshot.empty) {
                  window.location.href = "PreferencesLoad.html";
                } 
                else {
                  if (mode == "e"){
                    window.location.href = "eLoad.html";
                  }
                  else if (mode == "d"){
                    window.location.href = "DietLoad.html";
                  }
                }
            });
    }
    
    else {

        unsubscribe && unsubscribe();
    }
});
};

function RoutineFinder(){
  auth.onAuthStateChanged(user => {

    if (user) {

        
        thingsRef = db.collection('routines')
        console.log("Routine Finder")
        unsubscribe = thingsRef
            .where('uid', '==', user.uid)
            .onSnapshot(querySnapshot => {
              console.log("In Routine Finder")
                if (querySnapshot.empty) {
                  console.log("EMPTY")
                  window.location.href = "RoutineGenForm.html";
                } 
                else {
                  console.log("EMPTY")
                  window.location.href = "RoutineList.html";
                }
            });
    }
    
    else {

        unsubscribe && unsubscribe();
    }
});
}


function DietPlanSelection(index){
  auth.onAuthStateChanged(user => {

    thingsRef = db.collection('dietPlans')
    
      thingsRef.add({
        uid: user.uid,
        DietPlan: index
        
    });

    setTimeout(() => {
      window.location.href = 'DietDetails.html';
    }, 2000);
    
    }
  );
}



// function dietFetcher(lifestyleData, DietsDB){
//   auth.onAuthStateChanged(user => {
//     if (user) {
//       thingsRef = db.collection('dietPlans')
//       console.log("LOGGED")
//       unsubscribe = thingsRef
//           .where('uid', '==', user.uid)
//           .onSnapshot(querySnapshot => {
//             console.log("FETCHED")
//             if (querySnapshot.empty) {
//               console.log("EMPTY")
//             } 
//             else {
//                 console.log("Not Empty")
//                 querySnapshot.docs.forEach(doc => {
//                     console.log(doc.data().DietPlan)
//                     lifestyleData = DietsDB[Number(doc.data().DietPlan)];
//                     console.log(lifestyleData)
//                 })
                
//             }
//           });
//     }
//   });
// }


function LoadPreferencesGen(show,hide,hide2){
  document.getElementById(hide).hidden = true;
  document.getElementById(hide2).style.display = "none";
  document.getElementById(show).hidden = false;
  
}


function preferencechooser(){
  auth.onAuthStateChanged(user => {
    if (user) {

        
      thingsRef = db.collection('preferences')
      
      unsubscribe = thingsRef
          .where('uid', '==', user.uid)
          .onSnapshot(querySnapshot => {
            
              if (querySnapshot.empty) {
                window.location.href = "PSurvey.html";
              } 
              else {
                window.location.href = "PreferencesLoad.html";
              }
          });
  }
  
  else {

      unsubscribe && unsubscribe();
  }
  });
}