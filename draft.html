<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nourish Lifestyle</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>

    <script src="https://www.gstatic.com/firebasejs/7.16.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.16.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.16.1/firebase-firestore.js"></script>
    <script>
        var firebaseConfig = {
            apiKey: "AIzaSyBvONbLQcR-XqSsJ9hi7xAsk8sTwej43aA",
            authDomain: "ed-project-42419.firebaseapp.com",
            projectId: "ed-project-42419",
            storageBucket: "ed-project-42419.appspot.com",
            messagingSenderId: "909551078814",
            appId: "1:909551078814:web:456608495b9655eef6da8f"
        };
        firebase.initializeApp(firebaseConfig);
    </script>

    <script src="app.js"></script>

    <style>
        .progress-circle {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: conic-gradient(var(--primary-color) 0deg, #e5e7eb 0deg);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .progress-circle::before {
            content: attr(data-progress) '%';
            display: flex;
            align-items: center;
            justify-content: center;
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: var(--background-color);
            font-size: 1.5rem;
            font-weight: bold;
        }

        :root {
            --primary-color: #3b82f6;
            --secondary-color: #1e40af;
            --background-color: #ffffff;
            --text-color: #1f2937;
            --card-background: #ffffff;
            --card-border: #e5e7eb;
        }

        .dark {
            --primary-color: #60a5fa;
            --secondary-color: #93c5fd;
            --background-color: #1f2937;
            --text-color: #f3f4f6;
            --card-background: #374151;
            --card-border: #4b5563;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
        }

        .card {
            background-color: var(--card-background);
            border: 1px solid var(--card-border);
            border-radius: 0.5rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease;
        }

        .tab-trigger {
            padding: 0.5rem 1rem;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .tab-trigger.active {
            border-bottom-color: var(--primary-color);
            color: var(--primary-color);
        }

        .accordion-item {
            border-bottom: 1px solid var(--card-border);
        }

        .accordion-trigger {
            width: 100%;
            text-align: left;
            padding: 1rem 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .accordion-trigger:hover {
            color: var(--primary-color);
        }

        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .accordion-content.active {
            max-height: 1000px;
        }

        .progress-bar {
            height: 8px;
            background-color: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background-color: var(--primary-color);
            transition: width 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease forwards;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col transition-colors duration-300">
    <header class="p-4 flex justify-between items-center bg-white shadow-md">
        <h1 class="text-2xl font-bold">
            <span class="text-blue-600">Nourish</span> Lifestyle
        </h1>
        <button id="darkModeToggle" class="p-2 rounded-full">
            <i data-lucide="sun" class="h-5 w-5 text-yellow-400 hidden"></i>
            <i data-lucide="moon" class="h-5 w-5 text-blue-600"></i>
        </button>
    </header>

    <main class="flex-grow p-4 md:p-6 lg:p-8">
        <div class="max-w-7xl mx-auto">
            <div id="overviewCard" class="card mb-8">
                <!-- Overview content will be inserted here -->
            </div>

            <div id="challengeCard" class="card mb-8">
                <h3 class="text-xl font-semibold mb-4 text-center">30-Day Challenge</h3>
                <div class="flex items-center justify-center mb-4">
                    <div class="progress-circle" data-progress="0"></div>
                    <div class="ml-4 text-center">
                        <p class="text-lg font-semibold mb-2">Days Completed: <span id="daysCompleted">0</span>/30</p>
                        <button id="markDayButton" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition-colors">Mark Today as Completed</button>
                    </div>
                </div>
                <button id="completeChallengeButton" class="w-full bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 transition-colors opacity-50 cursor-not-allowed" disabled>Complete 30-Day Challenge</button>
                <button id="finishDietButton" class="mt-4 w-full bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600 transition-colors opacity-0 cursor-not-allowed" disabled style="display: none;">Finish Diet</button>
            </div>

            <div class="tabs mb-8">
                <div class="tab-list grid w-full grid-cols-4">
                    <button class="tab-trigger active" data-tab="foods">Foods</button>
                    <button class="tab-trigger" data-tab="meal-plan">Meal Plan</button>
                    <button class="tab-trigger" data-tab="benefits">Benefits</button>
                    <button class="tab-trigger" data-tab="considerations">Considerations</button>
                </div>
                <div id="tabContent" class="tab-content">
                    <!-- Tab content will be inserted here -->
                </div>
            </div>

            <div id="aiCheckerCard" class="card mb-8">
                <!-- AI Checker content will be inserted here -->
            </div>
        </div>
    </main>

    <footer class="py-4 text-center text-gray-600">
        <p>&copy; 2023 Nourish Lifestyle. All rights reserved.</p>
    </footer>

    <script>
        const DietsDB = [
    {
        "name": "Zone Diet",
        "description": "Balances macronutrients (proteins, carbohydrates, and fats) to reduce inflammation.",
        "averageCalories": 1500,
        "macronutrients": {
            "carbs": 40,
            "protein": 30,
            "fat": 30
        },
        "keyNutrients": [
            { "name": "Protein", "amount": "60-120g", "unit": "per day" },
            { "name": "Fiber", "amount": "25g", "unit": "per day" },
            { "name": "Omega-3", "amount": "1-2g", "unit": "per day" }
        ],
        "foodCategories": [
            {
                "name": "Lean Proteins",
                "icon": "fish",
                "foods": ["Chicken", "Fish (Salmon, Tuna)", "Eggs", "Tofu", "Lentils"]
            },
            {
                "name": "Low Glycemic Vegetables",
                "icon": "leaf",
                "foods": ["Broccoli", "Spinach", "Cucumbers", "Tomatoes", "Bell Peppers"]
            },
            {
                "name": "Fruits",
                "icon": "apple",
                "foods": ["Apples", "Berries", "Oranges", "Grapefruit"]
            },
            {
                "name": "Healthy Fats",
                "icon": "oil",
                "foods": ["Olive Oil", "Nuts (Almonds, Walnuts)", "Avocados"]
            }
        ],
        "mealPlan": [
            {
                "meal": "Breakfast",
                "options": [
                    "Egg white omelette with spinach and avocado",
                    "Greek yogurt with berries and almonds"
                ]
            },
            {
                "meal": "Lunch",
                "options": [
                    "Grilled chicken with mixed greens and olive oil dressing",
                    "Lentil soup with a side of cucumber salad"
                ]
            },
            {
                "meal": "Dinner",
                "options": [
                    "Baked salmon with steamed vegetables",
                    "Tofu stir-fry with broccoli and bell peppers"
                ]
            },
            {
                "meal": "Snacks",
                "options": [
                    "Mixed nuts",
                    "Fresh fruit"
                ]
            }
        ],
        "benefits": [
            "May aid in weight loss and improve overall health",
            "Balances energy levels",
            "Reduces inflammation"
        ],
        "considerations": [
            "Requires portion control to maintain balance of macronutrients",
            "May be difficult to follow in social settings"
        ],
        "category": "Weight Management",
        "keywords": ["Weight Loss", "Energy", "Metabolism", "Performance"],
        "dietTypes": ["veg", "non-veg", "egg"]
    },
    
];

       // Global variable to store lifestyle data
let lifestyleData;
let unsubscribe;

function dietFetcher(callback) {
    firebase.auth().onAuthStateChanged(user => {
        if (user) {
            console.log("User authenticated");
            const thingsRef = firebase.firestore().collection('dietPlans');
            unsubscribe = thingsRef
                .where('uid', '==', user.uid)
                .onSnapshot(querySnapshot => {
                    console.log("Fetching data");
                    if (querySnapshot.empty) {
                        console.log("No diet plan found for user");
                        callback(null);
                    } else {
                        console.log("Diet plan found");
                        querySnapshot.docs.forEach(doc => {
                            const dietPlanIndex = Number(doc.data().DietPlan);
                            if (DietsDB[dietPlanIndex]) {
                                lifestyleData = DietsDB[dietPlanIndex];
                                console.log("Lifestyle data set:", lifestyleData);
                                callback(lifestyleData);
                            } else {
                                console.error("Invalid diet plan index");
                                callback(null);
                            }
                        });
                    }
                }, error => {
                    console.error("Error fetching diet plan:", error);
                    callback(null);
                });
        } else {
            console.log("User not authenticated");
            callback(null);
        }
    });
}

function initializeApp() {
    dietFetcher((data) => {
        if (data) {
            console.log("Rendering with data:", data);
            renderOverviewCard();
            renderChallengeCard();
            renderTabs();
            renderAIChecker();
        } else {
            console.error("Failed to fetch lifestyle data");
            document.getElementById('overviewCard').innerHTML = '<p>Failed to load lifestyle data. Please make sure you are logged in and have a diet plan assigned.</p>';
        }
    });
}

function renderChallengeCard() {
    const challengeCard = document.getElementById('challengeCard');
    challengeCard.innerHTML = `
        <h3 class="text-xl font-semibold mb-4 text-center">30-Day Challenge</h3>
        <div class="flex items-center justify-center mb-4">
            <div class="progress-circle" data-progress="0"></div>
            <div class="ml-4 text-center">
                <p class="text-lg font-semibold mb-2">Days Completed: <span id="daysCompleted">0</span>/30</p>
                <button id="markDayButton" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition-colors">Mark Today as Completed</button>
            </div>
        </div>
        <button id="completeChallengeButton" class="w-full bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 transition-colors opacity-50 cursor-not-allowed" disabled>Complete 30-Day Challenge</button>
        <button id="finishDietButton" class="mt-4 w-full bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600 transition-colors opacity-0 cursor-not-allowed" disabled style="display: none;">Finish Diet</button>
    `;

    const markDayButton = document.getElementById('markDayButton');
    const completeChallengeButton = document.getElementById('completeChallengeButton');
    const finishDietButton = document.getElementById('finishDietButton');
    const daysCompletedSpan = document.getElementById('daysCompleted');
    const progressCircle = document.querySelector('.progress-circle');

    let daysCompleted = 0;

    // Fetch current progress and check for existing achievement
    firebase.auth().onAuthStateChanged(user => {
        if (user) {
            // Check if 30-day challenge achievement already exists
            firebase.firestore().collection('achievements').where('uid', '==', user.uid).where('name', '==', `${lifestyleData.name} 30 day challenge`).get()
                .then(querySnapshot => {
                    if (!querySnapshot.empty) {
                        completeChallengeButton.classList.add('opacity-50', 'cursor-not-allowed');
                        completeChallengeButton.disabled = true;
                        completeChallengeButton.textContent = 'Challenge Already Completed';
                    }
                });
        }
    });

    markDayButton.addEventListener('click', () => {
        if (daysCompleted < 30) {
            daysCompleted++;
            updateProgress();
        }
    });

    completeChallengeButton.addEventListener('click', () => {
        firebase.auth().onAuthStateChanged(user => {
            if (user) {
                const date = new Date();

                let day = date.getDate();
                let month = date.getMonth() + 1;
                let year = date.getFullYear();

                let currentDate = `${day} / ${month} / ${year}`;
                // Add achievement
                firebase.firestore().collection('achievements').add({
                    uid: user.uid,
                    name: `${lifestyleData.name} 30 day challenge`,
                    date: currentDate,
                }).then(() => {
                    alert('Congratulations on completing the 30-day challenge!');
                    completeChallengeButton.classList.add('opacity-50', 'cursor-not-allowed');
                    completeChallengeButton.disabled = true;
                    completeChallengeButton.textContent = 'Challenge Completed';
                });
            }
        });
    });
    
    finishDietButton.addEventListener('click', () => {
        firebase.auth().onAuthStateChanged(user => {
            if (user) {
                let date = new Date();
                let day = date.getDate();
                let month = date.getMonth() + 1;
                let year = date.getFullYear();
                
                let currentDate = `${day} / ${month} / ${year}`;
                // Add diet completion achievement
                firebase.firestore().collection('achevements').add({
                    uid: user.uid,
                    name: lifestyleData.name,
                    date: currentDate,
                }).then(() => {
                    auth.onAuthStateChanged(user => {
                        if (user) {
                            const thingsRef = firebase.firestore().collection('dietPlans');
                            
                            unsubscribe = thingsRef
                                .where('uid', '==', user.uid)
                                .onSnapshot(querySnapshot => {
                                    querySnapshot.forEach(doc => {
                                        thingsRef.doc(doc.id).delete();
                                        console.log("Deleted");
                                    });
                                    setTimeout(() => {
                                        window.location.href = 'index.html';
                                    }, 3000);
                                });
                        }
                    });
                });
            }
        });
    });

    function updateProgress() {
        daysCompletedSpan.textContent = daysCompleted;
        const progress = (daysCompleted / 30) * 100;
        progressCircle.style.background = `conic-gradient(var(--primary-color) ${progress * 3.6}deg, #e5e7eb 0deg)`;
        progressCircle.setAttribute('data-progress', Math.round(progress));

        if (daysCompleted === 30) {
            completeChallengeButton.classList.remove('opacity-50', 'cursor-not-allowed');
            completeChallengeButton.removeAttribute('disabled');
            finishDietButton.style.display = 'block';
            finishDietButton.classList.remove('opacity-0', 'cursor-not-allowed');
            finishDietButton.removeAttribute('disabled');
        }
    }
}

function initializeDarkMode() {
    const darkModeToggle = document.getElementById('darkModeToggle');
    const sunIcon = darkModeToggle.querySelector('[data-lucide="sun"]');
    const moonIcon = darkModeToggle.querySelector('[data-lucide="moon"]');

    const isDarkMode = localStorage.getItem('darkMode') === 'true';
    document.body.classList.toggle('dark', isDarkMode);
    updateDarkModeIcons(isDarkMode);

    darkModeToggle.addEventListener('click', () => {
        document.body.classList.toggle('dark');
        const isDark = document.body.classList.contains('dark');
        localStorage.setItem('darkMode', isDark);
        updateDarkModeIcons(isDark);
    });

    function updateDarkModeIcons(isDark) {
        sunIcon.classList.toggle('hidden', !isDark);
        moonIcon.classList.toggle('hidden', isDark);
    }
}

function renderOverviewCard() {
    if (!lifestyleData) {
        console.error("Lifestyle data is not available");
        return;
    }
    const overviewCard = document.getElementById('overviewCard');
    overviewCard.innerHTML = `
        <h2 class="text-3xl font-bold text-center mb-6">${lifestyleData.name}</h2>
        <p class="text-center mb-6">${lifestyleData.description}</p>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="card">
                <h3 class="text-lg font-semibold mb-2">Average Calories</h3>
                <p class="text-3xl font-bold text-center">${lifestyleData.averageCalories}</p>
                <p class="text-center">calories per day</p>
            </div>
            <div class="card">
                <h3 class="text-lg font-semibold mb-2">Macronutrients</h3>
                <div class="space-y-2">
                    ${Object.entries(lifestyleData.macronutrients).map(([nutrient, percentage]) => `
                        <div>
                            <div class="flex justify-between mb-1">
                                <span class="capitalize">${nutrient}</span>
                                <span>${percentage}%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-bar-fill" style="width: ${percentage}%"></div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
            <div class="card">
                <h3 class="text-lg font-semibold mb-2">Key Nutrients</h3>
                <ul class="space-y-2">
                    ${lifestyleData.keyNutrients.map(nutrient => `
                        <li class="flex justify-between">
                            <span>${nutrient.name}</span>
                            <span>${nutrient.amount} ${nutrient.unit}</span>
                        </li>
                    `).join('')}
                </ul>
            </div>
        </div>
    `;
}

function renderTabs() {
    if (!lifestyleData) {
        console.error("Lifestyle data is not available");
        return;
    }
    const tabTriggers = document.querySelectorAll('.tab-trigger');
    const tabContent = document.getElementById('tabContent');

    tabTriggers.forEach(trigger => {
        trigger.addEventListener('click', () => {
            tabTriggers.forEach(t => t.classList.remove('active'));
            trigger.classList.add('active');
            renderTabContent(trigger.dataset.tab);
        });
    });

    renderTabContent('foods');

    function renderTabContent(tab) {
        let content = '';
        switch (tab) {
            case 'foods':
                content = `
                    <div class="card">
                        <h3 class="text-xl font-semibold mb-4">Recommended Foods</h3>
                        <div class="accordion">
                            ${lifestyleData.foodCategories.map((category, index) => `
                                <div class="accordion-item">
                                    <button class="accordion-trigger" data-index="${index}">
                                        <div class="flex items-center">
                                            <i data-lucide="${category.icon}" class="w-6 h-6 mr-2"></i>
                                            <span>${category.name}</span>
                                        </div>
                                        <i data-lucide="chevron-down" class="w-5 h-5"></i>
                                    </button>
                                    <div class="accordion-content">
                                        <ul class="list-disc list-inside pl-4 py-2">
                                            ${category.foods.map(food => `<li>${food}</li>`).join('')}
                                        </ul>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                break;
            case 'meal-plan':
                content = `
                    <div class="card">
                        <h3 class="text-xl font-semibold mb-4">Sample Meal Plan</h3>
                        <div class="space-y-4">
                            ${lifestyleData.mealPlan.map(meal => `
                                <div>
                                    <h4 class="font-semibold text-lg mb-2">${meal.meal}</h4>
                                    <ul class="list-disc list-inside">
                                        ${meal.options.map(option => `<li>${option}</li>`).join('')}
                                    </ul>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                break;
            case 'benefits':
                content = `
                    <div class="card">
                        <h3 class="text-xl font-semibold mb-4">Benefits</h3>
                        <ul class="list-disc list-inside">
                            ${lifestyleData.benefits.map(benefit => `<li>${benefit}</li>`).join('')}
                        </ul>
                    </div>
                `;
                break;
            case 'considerations':
                content = `
                    <div class="card">
                        <h3 class="text-xl font-semibold mb-4">Considerations</h3>
                        <ul class="list-disc list-inside">
                            ${lifestyleData.considerations.map(consideration => `<li>${consideration}</li>`).join('')}
                        </ul>
                    </div>
                `;
                break;
        }
        tabContent.innerHTML = content;
        lucide.createIcons();
        initializeAccordion();
    }
}

function initializeAccordion() {
    const accordionTriggers = document.querySelectorAll('.accordion-trigger');
    accordionTriggers.forEach(trigger => {
        trigger.addEventListener('click', () => {
            const content = trigger.nextElementSibling;
            const icon = trigger.querySelector('[data-lucide="chevron-down"]');
            content.classList.toggle('active');
            icon.style.transform = content.classList.contains('active') ? 'rotate(180deg)' : 'rotate(0)';
        });
    });
}

function renderAIChecker() {
    if (!lifestyleData) {
        console.error("Lifestyle data is not available");
        return;
    }
    const aiCheckerCard = document.getElementById('aiCheckerCard');
    aiCheckerCard.innerHTML = `
        <h3 class="text-xl font-semibold mb-4">Lifestyle Compatibility Checker</h3>
        <div class="flex space-x-2 mb-4">
            <input type="text" id="foodInput" placeholder="Enter a food to check..." class="flex-grow p-2 border rounded">
            <button id="checkButton" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition-colors">Check</button>
        </div>
        <div id="aiResponse" class="hidden p-4 rounded-md"></div>
    `;

    const foodInput = document.getElementById('foodInput');
    const checkButton = document.getElementById('checkButton');
    const aiResponse = document.getElementById('aiResponse');

    checkButton.addEventListener('click', () => {
        const food = foodInput.value.trim();
        if (food) {
            checkFood(food);
        }
    });

    function checkFood(food) {
        const isAllowed = Math.random() > 0.3;
        const response = {
            allowed: isAllowed,
            message: isAllowed  
                ? `${food} can be incorporated into this balanced lifestyle. It offers nutritional benefits that align well with the lifestyle's principles.`
                : `While ${food} can be enjoyed occasionally, it may not be ideal for regular consumption in this balanced lifestyle. Consider healthier alternatives that are lower in processed ingredients or added sugars.`
        };

        aiResponse.innerHTML = `
            <div class="flex items-center mb-2">
                <i data-lucide="${response.allowed ? 'check' : 'x'}" class="w-6 h-6 ${response.allowed ? 'text-green-500' : 'text-red-500'} mr-2"></i>
                <span class="font-semibold">${response.allowed ? 'Compatible' : 'Less Ideal'}</span>
            </div>
            <p>${response.message}</p>
        `;
        aiResponse.classList.remove('hidden');
        aiResponse.classList.add('fade-in');
        aiResponse.style.backgroundColor = response.allowed ? '#f0fdf4' : '#fef2f2';
        lucide.createIcons();
    }
}

window.addEventListener('beforeunload', () => {
    if (unsubscribe) {
        unsubscribe();
    }
});

document.addEventListener('DOMContentLoaded', function() {
    initializeApp();
    initializeDarkMode();
});


    </script>
</body>
</html>